<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éŸ³å£°éŒ²éŸ³ï¼‹è©±è€…åˆ¤å®šã‚¢ãƒ—ãƒª</title>
</head>
<body>
    <h1>éŸ³å£°éŒ²éŸ³ï¼‹è©±è€…åˆ¤å®šã‚¢ãƒ—ãƒª</h1>

    <h2>â‘  å£°ã‚’ç™»éŒ²ã™ã‚‹ (æœ€åˆã«1å›)</h2>
    <button onclick="registerVoice()">å£°ã‚’ç™»éŒ²ğŸ¤</button>

    <h2>â‘¡ è©±è€…ã‚’åˆ¤å®šã™ã‚‹ (ä½•å›ã§ã‚‚)</h2>
    <button onclick="verifyVoice()">è©±è€…ã‚’åˆ¤å®šğŸ™ï¸</button>

    <h3>çµæœè¡¨ç¤ºï¼š</h3>
    <p id="result"></p>

<script>
let mediaRecorder;

const setButtonsDisabled = (isDisabled) => {
    document.querySelectorAll('button').forEach(btn => btn.disabled = isDisabled);
};

const recordAudio = (endpoint) => {
    setButtonsDisabled(true);

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        let audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks);
            const formData = new FormData();
            formData.append('audio_data', audioBlob, 'audio.webm');

            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('result').innerText = data.result;
            })
            .catch(error => {
                document.getElementById('result').innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            })
            .finally(() => {
                setButtonsDisabled(false);
            });
        };

        mediaRecorder.start();
        document.getElementById('result').innerText = "éŒ²éŸ³ä¸­â€¦ï¼ˆ2ç§’é–“ï¼‰";

        setTimeout(() => {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
        }, 2000); // â† 2ç§’ã§éŒ²éŸ³çµ‚äº†ï¼
    }).catch(e => {
        document.getElementById('result').innerText = "ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        setButtonsDisabled(false);
    });
};

const registerVoice = () => {
    recordAudio('/register_voice');
};

const verifyVoice = async () => {
    const checkRes = await fetch('/is_registered');
    const checkData = await checkRes.json();

    if (!checkData.registered) {
        document.getElementById('result').innerText = "âš ï¸ å£°ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšã¯ã€Œå£°ã‚’ç™»éŒ²ğŸ¤ã€ãƒœã‚¿ãƒ³ã§ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚";
        return;
    }

    recordAudio('/verify_voice');
};
</script>
</body>
</html>